#!/bin/bash

if [ -z "$1" ]
then
  echo "Usage: $0 date"
  exit 1
fi
mkdir -p log_files
filename="log_files/$1.tsv"

if [ ! -f "$filename" ]
then
  echo "Downloading log file..."
  ./client $1
  echo "Log file downloaded."
fi

echo "Generating report."

# TODO Handle bad requests (code=XX)
raw_file=$(cat $filename | ag 'heroku/router' --nocolor | ag -v 'code=')

# TODO Handle entries with NF != 20
echo "$raw_file" | awk 'NF == 20\
  {
    match($0, /status=([0-9]+)/, status)
    status_code = status[1]
    match($0, /path="([^\?"]+)/, path_matched)
    path = path_matched[1]
    ip = $6

    IPS_REQ[ip]++

    if(status_code == 500) {
      STATUS_500[path]++
    }

    if(path !~ /assets|favicon/) {
      REQS[path]++
    }

    if(path ~ /assets|favicon/) {
      ASSET_REQS[path]++
    }

    TOTAL++
    STATUS_CODES[status_code]++
  }
  END {
    printf("%s: %d\n\n", "Total requests", TOTAL)

    printf("%s\n","***REMOVED*** " )
    for(x in STATUS_CODES) {
      percentage = STATUS_CODES[x] / TOTAL * 100
      printf("%s: %d (%.2f%)\n", x, STATUS_CODES[x], percentage)
    }

    # Sort arrays by values descending
    PROCINFO["sorted_in"] = "@val_num_desc"

    printf("\n%s\n","***REMOVED***" )
    i = 1; for(k in STATUS_500) {
      print STATUS_500[k] ": " k

      i++; if ( i == 10 ) { break }
    }

    printf("\n%s\n","***REMOVED***" )
    i = 1; for(k in REQS) {
      print REQS[k] ": " k

      i++; if ( i == 20 ) { break }
    }

    printf("\n%s\n","***REMOVED***" )
    i = 1; for(k in IPS_REQ) {
      print IPS_REQ[k] ": " k

      i++; if ( i == 20 ) { break }
    }

    printf("\n%s\n","***REMOVED***" )
    i = 1; for(k in ASSET_REQS) {
      print ASSET_REQS[k] ": " k

      i++; if ( i == 20 ) { break }
    }
  }'
